---
- name: Configuration automatique du serveur nsapool
  hosts: nsapoold05
  become: yes
  vars:
    web_root: "/var/www/html"

  tasks:
    # 1. Mise à jour du système
    - name: Mise à jour des paquets APT
      apt:
        update_cache: yes
        cache_valid_time: 3600

    # 2. Vérification que MariaDB est démarré
    - name: S'assurer que MariaDB est démarré
      service:
        name: mariadb
        state: started
        enabled: yes

    # 3. Création du répertoire web si nécessaire
    - name: S'assurer que le répertoire web existe
      file:
        path: "{{ web_root }}"
        state: directory
        mode: '0755'

    # 4. Copie du fichier PHP
    - name: Déploiement du fichier data.php
      copy:
        src: student_day05/data.php
        dest: "{{ web_root }}/data.php"
        mode: '0644'

    # 5. Configuration des permissions
    - name: Configuration des permissions du répertoire web
      file:
        path: "{{ web_root }}"
        owner: www-data
        group: www-data
        recurse: yes

    # 6. Redémarrage d'Apache (si installé)
    - name: Redémarrage d'Apache2
      service:
        name: apache2
        state: restarted
      ignore_errors: yes

    - name: Redémarrage de Nginx
      service:
        name: nginx
        state: restarted
      ignore_errors: yes

    - name: Message de succès
      debug:
        msg: "Installation terminée ! Accédez à http://localhost/data.php pour tester"